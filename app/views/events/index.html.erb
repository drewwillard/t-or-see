<p style="color: green"><%= notice %></p>

<% content_for :title, "Events" %>

<h1>Events</h1>

<div id="events">
<%= turbo_frame_tag "events" do %>
  <div>
    <div class="event-toggle-wrapper">
      <div class="event-toggle">
        <%= link_to "Upcoming Events", events_path, 
            class: "toggle-option #{params[:filter] != 'past' ? 'active' : ''}", 
            data: { turbo_frame: "events" } %>
        <%= link_to "Past Events", events_path(filter: :past), 
            class: "toggle-option #{params[:filter] == 'past' ? 'active' : ''}", 
            data: { turbo_frame: "events" } %>
      </div>
    </div>
    
    <div>
      <%= form_with url: events_path, method: :get, data: { turbo_frame: "events" } do |form| %>
        <div>
          <%= form.label :start_date, "From:" %>
          <%= form.date_field :start_date, value: params[:start_date] %>
          
          <%= form.label :end_date, "To:" %>
          <%= form.date_field :end_date, value: params[:end_date] %>
          
          <%= form.submit "Filter by Date" %>
        </div>
      <% end %>
    </div>
  </div>

  <% 
    events = if params[:filter] == "past"
      @events.past.order(date: :desc, start_time: :desc)
    elsif params[:start_date].present? || params[:end_date].present?
      filtered_events = @events
      if params[:start_date].present?
        start_date = Date.parse(params[:start_date])
        filtered_events = filtered_events.where("date >= ?", start_date)
      end
      if params[:end_date].present?
        end_date = Date.parse(params[:end_date])
        filtered_events = filtered_events.where("date <= ?", end_date)
      end
      filtered_events.order(date: :asc, start_time: :asc)
    else
      @events.upcoming.order(date: :asc, start_time: :asc)
    end
  %>
  
  <% if events.any? %>
    <% events.each do |event| %>
      <%= turbo_frame_tag dom_id(event) do %>
        <%= render event %>
        <br>
        <br>
      <% end %>
    <% end %>
  <% else %>
    <p>No events found for the selected criteria.</p>
  <% end %>
<% end %>

</div>

<% if user_signed_in? && current_user.manager? %>
  <%= link_to "New event", new_event_path, data: { turbo_frame: "events" } %>
<% end %>
